---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import SectionIndex from '../components/SectionIndex.astro';
import Section from '../components/Section.astro';
import BlogCard from '../components/BlogCard.astro';
import ExternalLink from '../components/ExternalLink.astro';
import SkillCategory from '../components/SkillCategory.astro';
import ExperienceEntry from '../components/ExperienceEntry.astro';

const posts = await getCollection('thoughts', ({ data }) => !data.draft);
const sortedPosts = posts
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 3);

const experiences = [
  {
    dateRange: "Jul 2024 — Present",
    role: "Solutions Engineer",
    company: "HERE (OpenFin)",
    description: "Growing the Asia-Pac region by forging technical pre and post-sales relationships. Collaborating with sales, engineering, product, and customer success teams to ensure successful implementations of the HERE Enterprise Browser. On-site consulting and hands-on engineering for a forthcoming, groundbreaking desktop platform at a major Australian institution."
  },
  {
    dateRange: "Jan 2024 — Jul 2024",
    role: "Senior Software Engineer",
    company: "Leonardo.Ai",
    description: "Software engineering and thought leadership at Australia's leading hyper-growth AI startup. Led the build of the flagship Image Generation v2 interface and contributed to key features like the Universal Upscaler during a pivotal growth phase. Improved delivery cadence, contributed to extensive hiring, and coached the team on scale-up delivery best practices."
  },
  {
    dateRange: "Jan 2020 — Sep 2023",
    role: "Head of UI / UX",
    company: "Yieldbroker",
    description: "Owned discovery and delivery of a high-performance financial trading platform, combining hands-on software engineering, UX design, and people management. Led chapter for all UI engineers through hiring, mentoring, and coaching. Worked closely with the CTO on organisational design. Established and led UX design practice with rapid prototypes, high-fidelity designs, and design systems in Figma."
  },
  {
    dateRange: "Mar 2010 — Dec 2019",
    role: "Consultant Software Engineer",
    company: "Lab49",
    description: "Go-to specialist for high-performance financial trading UIs across major institutions. Worked on commodities trading at Commonwealth Bank, leading the multi-year build of a new metals trading platform. Developed rich UIs for foreign exchange trading at NAB, fixed income at UBS, and contributed to the Matrix platform at Morgan Stanley. Expertise in streaming data, data grids, visualisations, and compliance-heavy environments."
  }
];

const skillCategories = [
  { title: "Front-end", skills: ["TypeScript", "React", "Next.js", "TanStack", "XState", "Angular", "RxJS", "Storybook", "SvelteKit", "Tailwind"] },
  { title: "Back-end", skills: ["Node", "tRPC", "Drizzle", "REST", "NestJS", "GraphQL", "Postgres", "PayloadCMS"] },
  { title: "Mobile", skills: ["React Native", "Expo"] },
  { title: "Testing & Cloud", skills: ["Cypress", "Puppeteer", "Cucumber", "Playwright", "AWS", "Vercel", "Clerk", "Railway", "Convex"] },
  { title: "AI & Developer Tools", skills: ["MCP", "OpenAI API", "Ollama", "Claude Code", "Gemini CLI", "V0", "Bolt", "Lovable", "n8n"] },
  { title: "Engineering Management", skills: ["Hiring", "Mentoring", "Code reviews", "DORA metrics", "Team Topologies", "Flow metrics", "Continuous delivery", "Scrum", "Lean/Kanban"] },
  { title: "User Experience Design", skills: ["Prototyping", "Journey mapping", "Personas", "One-pagers", "Interaction design", "Story mapping", "Design systems", "Figma", "Sketch", "Zeplin", "Axure"] },
  { title: "Product Management", skills: ["Product roadmaps", "Requirements gathering", "OKRs", "Stakeholder collaboration", "Pre-sales consulting"] },
  { title: "Domain Knowledge", skills: ["Foreign exchange", "Fixed income", "Commodities", "Regulation", "Image generation", "Developer productivity"] }
];
---

<BaseLayout title="Ray Cashmore — Product Engineer">
  <SectionIndex />

  <main>
    <!-- Section 01: Hero -->
    <section id="hero" class="dark min-h-screen flex flex-col justify-end pb-[12vh] lg:pb-[15vh] relative overflow-hidden bg-[rgb(0,0,0)] text-[rgb(255,255,255)]">
      <canvas id="dot-grid" class="absolute inset-0 w-full h-full pointer-events-none"></canvas>
      <div class="relative z-10 px-8 lg:px-16 xl:px-24 max-w-[90vw] lg:max-w-[70vw]">
        <h1 class="type-hero-name">
          <span class="block">Ray</span>
          <span class="block">Cashmore</span>
        </h1>
        <p class="type-hero-tagline mt-24 lg:mt-32">
          <span id="cycling-title" class="block cycling-text">Product Engineer</span>
        </p>
      </div>
    </section>

    <script>
      const canvas = document.getElementById('dot-grid') as HTMLCanvasElement;
      const ctx = canvas.getContext('2d')!;

      const DOT_SPACING = 24;
      const DOT_RADIUS = 1;
      const BASE_OPACITY = 0.03;
      const WAVE_OPACITY = 0.25;

      let dots: { x: number; y: number; phase: number }[] = [];
      let animationId: number;

      function resize() {
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
        createDots(rect.width, rect.height);
      }

      function createDots(width: number, height: number) {
        dots = [];
        const cols = Math.ceil(width / DOT_SPACING) + 1;
        const rows = Math.ceil(height / DOT_SPACING) + 1;

        for (let row = 0; row < rows; row++) {
          for (let col = 0; col < cols; col++) {
            dots.push({
              x: col * DOT_SPACING,
              y: row * DOT_SPACING,
              phase: Math.random() * 0.5
            });
          }
        }
      }

      function draw(time: number) {
        const rect = canvas.getBoundingClientRect();
        ctx.clearRect(0, 0, rect.width, rect.height);

        // Hero section is always dark, so dots are always white
        const baseColor = '255, 255, 255';

        dots.forEach(dot => {
          const diagonal = (dot.x + dot.y) / 300;
          const wave1 = Math.sin(time * 0.0008 + diagonal + dot.phase);
          const wave2 = Math.sin(time * 0.0006 - diagonal * 0.7 + dot.phase * 1.3);
          const wave3 = Math.sin(time * 0.001 + diagonal * 0.5 + dot.phase * 0.8);

          const combined = (wave1 + wave2 + wave3) / 3;
          const opacity = BASE_OPACITY + (combined * 0.5 + 0.5) * WAVE_OPACITY;

          ctx.beginPath();
          ctx.arc(dot.x, dot.y, DOT_RADIUS, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(${baseColor}, ${opacity})`;
          ctx.fill();
        });

        animationId = requestAnimationFrame(draw);
      }

      resize();
      window.addEventListener('resize', resize);
      animationId = requestAnimationFrame(draw);
    </script>

    <script>
      const titles = [
        'Product Engineer',
        'Interaction Designer',
        'Engineering Manager'
      ];

      let currentIndex = 0;
      const cyclingElement = document.getElementById('cycling-title');

      if (cyclingElement) {
        setInterval(() => {
          cyclingElement.classList.add('fade-out');

          setTimeout(() => {
            currentIndex = (currentIndex + 1) % titles.length;
            cyclingElement.textContent = titles[currentIndex];

            setTimeout(() => {
              cyclingElement.classList.remove('fade-out');
            }, 200);
          }, 800);
        }, 5000);
      }
    </script>

    <!-- Section 02: About -->
    <Section id="about" number="02" class="border-t border-border">
      <p class="text-xl md:text-2xl leading-relaxed text-muted max-w-3xl">
        Engineering leader working at the intersection of technology, design, and product. Extensive experience leading ambitious teams in varied domains including generative AI and financial trading. Skilled in growing people, improving processes, hands-on coding, and driving organisational outcomes.
      </p>
    </Section>

    <!-- Section 03: Experience -->
    <Section id="experience" number="03" class="border-t border-border">
      <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-6 mb-16">
        <h2 class="type-section-title">Experience</h2>
        <a
          href="/ray-cashmore-cv.pdf"
          download
          class="inline-flex items-center gap-2 px-5 py-2.5 border border-foreground hover:bg-foreground hover:text-background transition-colors text-sm font-medium"
        >
          Download CV
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" />
          </svg>
        </a>
      </div>

      <!-- Experience Entries -->
      <div class="space-y-12 mb-20">
        {experiences.map((exp, i) => (
          <ExperienceEntry {...exp} isLast={i === experiences.length - 1} />
        ))}
      </div>

      <!-- Education -->
      <div class="mb-20">
        <h3 class="type-label text-muted mb-10">Education</h3>
        <article class="grid md:grid-cols-4 gap-4 pb-12 border-b border-border">
          <div class="text-sm text-muted"></div>
          <div class="md:col-span-3">
            <h4 class="font-medium text-lg">Bachelor of Information Technology</h4>
            <p class="text-muted mt-1">University of Canberra</p>
            <p class="text-muted text-sm mt-1">Minor: Marketing</p>
          </div>
        </article>
        <article class="grid md:grid-cols-4 gap-4">
          <div class="text-sm text-muted"></div>
          <div class="md:col-span-3">
            <h4 class="font-medium text-lg">Senior Secondary Certificate</h4>
            <p class="text-muted mt-1">Marist College</p>
          </div>
        </article>
      </div>

      <!-- Skills -->
      <div>
        <h3 class="type-label text-muted mb-10">Skills</h3>
        {skillCategories.map(category => (
          <SkillCategory title={category.title} skills={category.skills} />
        ))}
      </div>
    </Section>

    <!-- Section 04: Connect -->
    <Section id="connect" number="04" class="border-t border-border">
      <div class="grid md:grid-cols-2 gap-16 md:gap-24">
        <!-- Thoughts -->
        <div>
          <h2 class="type-label text-muted mb-10">Thoughts</h2>
          {sortedPosts.length > 0 ? (
            <div class="space-y-8 mb-8">
              {sortedPosts.map((post) => (
                <BlogCard
                  title={post.data.title}
                  date={post.data.date}
                  slug={post.id}
                  excerpt={post.data.excerpt}
                />
              ))}
            </div>
          ) : (
            <p class="text-muted mb-8">No posts yet.</p>
          )}
          <a href="/thoughts" class="text-lg hover:opacity-60 inline-flex items-center gap-2">
            View all writing
            <span aria-hidden="true">→</span>
          </a>
        </div>

        <!-- Links -->
        <div>
          <h2 class="type-label text-muted mb-10">Links</h2>
          <div class="space-y-4">
            <div>
              <ExternalLink href="https://linkedin.com/in/raycashmore" label="LinkedIn" />
            </div>
            <div>
              <ExternalLink href="https://github.com/raycashmore" label="GitHub" />
            </div>
          </div>
        </div>
      </div>
    </Section>
  </main>
</BaseLayout>
