---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import SectionIndex from '../components/SectionIndex.astro';
import Section from '../components/Section.astro';
import ExternalLink from '../components/ExternalLink.astro';
import ExperienceEntry from '../components/ExperienceEntry.astro';

const posts = await getCollection('thoughts', ({ data }) => !data.draft);
const sortedPosts = posts
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 3);

const experiences = [
  {
    dateRange: "Jul 2024 — Now",
    role: "Solutions Engineer",
    company: "HERE (OpenFin)",
    description: "Driving adoption of the HERE Enterprise Browser across the Asia-Pacific region. Forward deployed engineer at a major Australian financial institution, bridging product, engineering, and customer success to deliver successful implementations."
  },
  {
    dateRange: "Jan 2024 — Jul 2024",
    role: "Senior Software Engineer",
    company: "Leonardo.Ai",
    description: "Joined Australia's fastest-growing AI startup and led the development of the Image Generation v2 interface and contributed to key features like the Universal Upscaler during a pivotal growth phase - just prior to acquisition by Canva. Improved delivery cadence, contributed to extensive hiring, and coached the team on engineering best practices."
  },
  {
    dateRange: "Jan 2020 — Sep 2023",
    role: "Head of UI / UX",
    company: "Yieldbroker",
    description: "Spearheaded a complete rebuild of a fixed income trading platform that underpins the Australian financial industry. Built and led a high-performing UI/UX team, owned end-to-end discovery and delivery, and collaborated with the CTO to transition the organisation toward a product operating model."
  },
  {
    dateRange: "Mar 2010 — Dec 2019",
    role: "Senior Software Engineer",
    company: "Lab49",
    description: "Go-to specialist for innovative trading platforms at major financial institutions across APAC, US, and Europe. Specialised in streaming data, real-time visualisation, and mission-critical interfaces."
  }
];

const earlyCareer = [
  { role: "Adobe Consulting", description: "Built exclusive social network for the World Economic Forum" },
  { role: "Razorfish, R/GA, Cimex", description: "Freelance roles at London's top digital agencies" },
  { role: "Doof", description: "Early employee at hyper-growth online gaming startup" },
  { role: "Catalyst, Learning Curve, Nortia", description: "Developed interactive E-Learning platforms" },
  { role: "Art Direction", description: "Introduced data-driven websites to highly creative print-based design agency" }
];

const coreSkills = ["TypeScript", "React", "AI-driven development", "Product design", "Engineering management", "Pre-sales"];
---

<BaseLayout title="Ray Cashmore — Product Engineer">
  <SectionIndex />

  <main>
    <!-- Section 01: Hero -->
    <section id="hero" class="dark min-h-screen flex flex-col justify-end pb-[12vh] lg:pb-[15vh] relative overflow-hidden bg-[rgb(0,0,0)] text-[rgb(255,255,255)]">
      <canvas id="dot-grid" class="absolute inset-0 w-full h-full pointer-events-none"></canvas>
      <div class="relative z-10 px-8 lg:px-16 xl:px-24 max-w-[90vw] lg:max-w-[70vw]">
        <h1 class="type-hero-name">
          <span class="block">Ray</span>
          <span class="block">Cashmore</span>
        </h1>
        <p class="type-hero-tagline mt-24 lg:mt-32">
          <span id="cycling-title" class="block cycling-text">Product Engineer</span>
        </p>
      </div>
    </section>

    <script>
      const canvas = document.getElementById('dot-grid') as HTMLCanvasElement;
      const ctx = canvas.getContext('2d')!;

      const DOT_SPACING = 24;
      const DOT_RADIUS = 1;
      const BASE_OPACITY = 0.03;
      const WAVE_OPACITY = 0.25;

      let dots: { x: number; y: number; phase: number }[] = [];
      let animationId: number;

      function resize() {
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
        createDots(rect.width, rect.height);
      }

      function createDots(width: number, height: number) {
        dots = [];
        const cols = Math.ceil(width / DOT_SPACING) + 1;
        const rows = Math.ceil(height / DOT_SPACING) + 1;

        for (let row = 0; row < rows; row++) {
          for (let col = 0; col < cols; col++) {
            dots.push({
              x: col * DOT_SPACING,
              y: row * DOT_SPACING,
              phase: Math.random() * 0.5
            });
          }
        }
      }

      function draw(time: number) {
        const rect = canvas.getBoundingClientRect();
        ctx.clearRect(0, 0, rect.width, rect.height);

        const baseColor = '255, 255, 255';

        dots.forEach(dot => {
          const diagonal = (dot.x + dot.y) / 300;
          const wave1 = Math.sin(time * 0.0008 + diagonal + dot.phase);
          const wave2 = Math.sin(time * 0.0006 - diagonal * 0.7 + dot.phase * 1.3);
          const wave3 = Math.sin(time * 0.001 + diagonal * 0.5 + dot.phase * 0.8);

          const combined = (wave1 + wave2 + wave3) / 3;
          const opacity = BASE_OPACITY + (combined * 0.5 + 0.5) * WAVE_OPACITY;

          ctx.beginPath();
          ctx.arc(dot.x, dot.y, DOT_RADIUS, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(${baseColor}, ${opacity})`;
          ctx.fill();
        });

        animationId = requestAnimationFrame(draw);
      }

      resize();
      window.addEventListener('resize', resize);
      animationId = requestAnimationFrame(draw);
    </script>

    <script>
      const titles = [
        'Product Engineer',
        'Interaction Designer',
        'Engineering Manager',
        'AI Fiddler'
      ];

      let currentIndex = 0;
      const cyclingElement = document.getElementById('cycling-title');

      if (cyclingElement) {
        setInterval(() => {
          cyclingElement.classList.add('fade-out');

          setTimeout(() => {
            currentIndex = (currentIndex + 1) % titles.length;
            cyclingElement.textContent = titles[currentIndex];

            setTimeout(() => {
              cyclingElement.classList.remove('fade-out');
            }, 200);
          }, 800);
        }, 5000);
      }
    </script>

    <!-- Section 02: About -->
    <Section id="about" number="02" class="border-t border-border">
      <p class="text-xl md:text-2xl leading-relaxed text-muted max-w-3xl">
        Engineering leader working at the intersection of technology, design, and product. Extensive experience leading ambitious teams in varied domains including generative AI and financial trading. Skilled in growing people, improving processes, hands-on coding, and driving organisational outcomes.
      </p>
    </Section>

    <!-- Section 03: Experience -->
    <Section id="experience" number="03" class="border-t border-border">
      <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-6 mb-16">
        <h2 class="type-section-title">Experience</h2>
        <a
          href="/ray-cashmore-cv.pdf"
          download
          class="inline-flex items-center gap-2 px-5 py-2.5 border border-foreground hover:bg-foreground hover:text-background transition-colors text-sm font-medium"
        >
          Download CV
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" />
          </svg>
        </a>
      </div>

      <!-- Experience Entries -->
      <div class="space-y-12 mb-20">
        {experiences.map((exp, i) => (
          <ExperienceEntry {...exp} isLast={i === experiences.length - 1} />
        ))}
      </div>

      <!-- Early Career Highlights -->
      <div class="mb-20 pt-12 border-t border-border">
        <div class="grid md:grid-cols-4 gap-4">
          <div class="text-sm text-muted">Early career highlights</div>
          <div class="md:col-span-3 space-y-3">
            {earlyCareer.map((item) => (
              <p class="text-sm"><span class="font-medium">{item.role}</span> — <span class="text-muted">{item.description}</span></p>
            ))}
          </div>
        </div>
      </div>

      <!-- Skills -->
      <div>
        <h3 class="type-label text-muted mb-10">Core Skills</h3>
        <div class="flex flex-wrap gap-3">
          {coreSkills.map(skill => (
            <span class="px-4 py-2 border border-border text-sm">{skill}</span>
          ))}
        </div>
      </div>
    </Section>

    <!-- Section 04: Connect -->
    <Section id="connect" number="04" class="border-t border-border">
      <div class="grid md:grid-cols-2 gap-16 md:gap-24">
        <!-- Thoughts (hidden for now)
        <div>
          <h2 class="type-label text-muted mb-10">Thoughts</h2>
          {sortedPosts.length > 0 ? (
            <div class="space-y-8 mb-8">
              {sortedPosts.map((post) => (
                <BlogCard
                  title={post.data.title}
                  date={post.data.date}
                  slug={post.id}
                  excerpt={post.data.excerpt}
                />
              ))}
            </div>
          ) : (
            <p class="text-muted mb-8">No posts yet.</p>
          )}
          <a href="/thoughts" class="text-lg hover:opacity-60 inline-flex items-center gap-2">
            View all writing
            <span aria-hidden="true">→</span>
          </a>
        </div>
        -->

        <!-- Links -->
        <div>
          <h2 class="type-label text-muted mb-10">Links</h2>
          <div class="space-y-4">
            <div>
              <ExternalLink href="https://linkedin.com/in/raycashmore" label="LinkedIn" />
            </div>
            <div>
              <ExternalLink href="https://github.com/raycashmore" label="GitHub" />
            </div>
            <div>
              <a
                href="#"
                id="email-link"
                class="inline-flex items-center gap-2 text-foreground hover:opacity-60"
                data-u="ray"
                data-d="cashmore.me"
              >Email</a>
            </div>
          </div>
        </div>
      </div>
    </Section>
  </main>
</BaseLayout>

<script>
  // Obfuscated email to prevent spam bots
  const emailLink = document.getElementById('email-link');
  if (emailLink) {
    emailLink.addEventListener('click', (e) => {
      e.preventDefault();
      const u = emailLink.getAttribute('data-u');
      const d = emailLink.getAttribute('data-d');
      window.location.href = 'mailto:' + u + '@' + d;
    });
  }
</script>
